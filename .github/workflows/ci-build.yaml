name: CI Build

on:
  pull_request:
    types:
      - opened
    branches-ignore:
      - 'ga-ignore-**'
  push:
    branches-ignore:
      - 'ga-ignore-**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake python3-dev ffmpeg libopencv-dev g++-13 gcc-13 lcov bc
          sudo apt-get install -y libcurl4-openssl-dev libgtest-dev libgmock-dev

      - name: Set CXX environment variable
        run: |
          g++-13 --version
          g++ --version
          echo "CXX=$(which g++-13)" >> $GITHUB_ENV

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.2.4'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_CXX_COMPILER=$(which g++-13) -DCI_BUILD=ON

      - name: Build the project
        run: make -C build

      - name: copy executable
        run: cp build/video-code video-code

      - name: Run video-code
        run: |
          ./video-code --generate out.mp4
          if [ $? -ne 0 ] || [ ! -f "out.mp4" ]; then
            echo "Error: video-code failed to generate out.mp4."
            exit 1
          fi
          mkdir -p video
          mv out.mp4 video/video_result.mp4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Python tests with coverage
        run: |
          pytest tests/python/ --cov=videocode --cov-report=term-missing --cov-report=xml --cov-report=html --cov-fail-under=95
          echo "Python coverage report generated"

      - name: Configure CMake with coverage
        run: cmake -S . -B build_test -DCMAKE_CXX_COMPILER=$(which g++-13) -DCI_BUILD=ON -DENABLE_COVERAGE=ON -DBUILD_TESTS=ON

      - name: Build C++ tests
        run: make -C build_test

      - name: Run C++ tests
        run: |
          cd build_test
          export QT_QPA_PLATFORM=offscreen
          ctest --output-on-failure || true

      - name: Generate C++ coverage report
        run: |
          cd build_test
          lcov --capture --directory . --output-file coverage.info --rc geninfo_unexecuted_blocks=1 --ignore-errors mismatch,mismatch
          lcov --remove coverage.info '/usr/*' '*/vcpkg_installed/*' '*/tests/*' --output-file coverage_filtered.info
          lcov --list coverage_filtered.info

      - name: Check C++ coverage threshold
        run: |
          cd build_test
          coverage_percent=$(lcov --summary coverage_filtered.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
          echo "C++ coverage: ${coverage_percent}%"
          if (( $(echo "$coverage_percent < 40" | bc -l) )); then
            echo "Error: C++ coverage is below 40% (current: ${coverage_percent}%)"
            exit 1
          fi
          echo "C++ coverage requirement met: ${coverage_percent}%"

      - name: Upload Python coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-coverage-report
          path: htmlcov/

      - name: Upload C++ coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cpp-coverage-report
          path: build_test/coverage_filtered.info